$(function() {
	function f(l) {
		var k = 0;
		$(l).each(function() {
			k += $(this).outerWidth(true)
		});
		return k
	}
	function g(n) {
		var o = f($(n).prevAll()), q = f($(n).nextAll());
		var l = f($(".content-tabs").children().not(".J_menuTabs"));
		var k = $(".content-tabs").outerWidth(true) - l;
		var p = 0;
		if ($(".page-tabs-content").outerWidth() < k) {
			p = 0
		} else {
			if (q <= (k - $(n).outerWidth(true) - $(n).next().outerWidth(true))) {
				if ((k - $(n).next().outerWidth(true)) > q) {
					p = o;
					var m = n;
					while ((p - $(m).outerWidth()) > ($(".page-tabs-content")
							.outerWidth() - k)) {
						p -= $(m).prev().outerWidth();
						m = $(m).prev()
					}
				}
			} else {
				if (o > (k - $(n).outerWidth(true) - $(n).prev().outerWidth(
						true))) {
					p = o - $(n).prev().outerWidth(true)
				}
			}
		}
		$(".page-tabs-content").animate({
			marginLeft : 0 - p + "px"
		}, "fast")
	}
	function a() {
		var o = Math.abs(parseInt($(".page-tabs-content").css("margin-left")));
		var l = f($(".content-tabs").children().not(".J_menuTabs"));
		var k = $(".content-tabs").outerWidth(true) - l;
		var p = 0;
		if ($(".page-tabs-content").width() < k) {
			return false
		} else {
			var m = $(".J_menuTab:first");
			var n = 0;
			while ((n + $(m).outerWidth(true)) <= o) {
				n += $(m).outerWidth(true);
				m = $(m).next()
			}
			n = 0;
			if (f($(m).prevAll()) > k) {
				while ((n + $(m).outerWidth(true)) < (k) && m.length > 0) {
					n += $(m).outerWidth(true);
					m = $(m).prev()
				}
				p = f($(m).prevAll())
			}
		}
		$(".page-tabs-content").animate({
			marginLeft : 0 - p + "px"
		}, "fast")
	}
	function b() {
		var o = Math.abs(parseInt($(".page-tabs-content").css("margin-left")));
		var l = f($(".content-tabs").children().not(".J_menuTabs"));
		var k = $(".content-tabs").outerWidth(true) - l;
		var p = 0;
		if ($(".page-tabs-content").width() < k) {
			return false
		} else {
			var m = $(".J_menuTab:first");
			var n = 0;
			while ((n + $(m).outerWidth(true)) <= o) {
				n += $(m).outerWidth(true);
				m = $(m).next()
			}
			n = 0;
			while ((n + $(m).outerWidth(true)) < (k) && m.length > 0) {
				n += $(m).outerWidth(true);
				m = $(m).next()
			}
			p = f($(m).prevAll());
			if (p > 0) {
				$(".page-tabs-content").animate({
					marginLeft : 0 - p + "px"
				}, "fast")
			}
		}
	}
	$(".J_menuItem").each(function(k) {
		if (!$(this).attr("data-index")) {
			$(this).attr("data-index", k)
		}
	});
	//单击J_menuItem时触发
	function c() {
		//o是超链接的href地址  m是index索引 l是文本内容 k是true
		var o = $(this).attr("href"), m = $(this).data("index"), l = $.trim($(
				this).text()), k = true;
		//如果地址没有定义
		if (o == undefined || $.trim(o).length == 0) {
			//返回false 不执行 tab创建操作
			return false
		}
		//检查这个超链接是否已经存在tabs里
		$(".J_menuTab").each(
				function() {
					if ($(this).data("id") == o) {
						//如果存在判断是状态否是活动的
						if (!$(this).hasClass("active")) {
							//如果不是活动的							
							//siblings方法找到每个div的所有同辈元素。移除同辈元素的active状态
							$(this).addClass("active").siblings(".J_menuTab")
									.removeClass("active");
							//执行g函数
							g(this);
							//隐藏iframe
							$(".J_mainContent .J_iframe").each(
									function() {
										if ($(this).data("id") == o) {
											$(this).show()
													.siblings(".J_iframe")
													.hide();
											return false
										}
									})
						}
						//状态标识
						k = false;
						return false
					}
				});
		//k为true代表还没创建新的tab 
		if (k) {
			//l代表连接的中文名字
			var p = '<a href="javascript:;" class="active J_menuTab" data-id="'
					+ o + '">' + l + ' <i class="fa fa-times-circle"></i></a>';
			$(".J_menuTab").removeClass("active");
			var n = '<iframe class="J_iframe" name="iframe' + m
					+ '" width="100%" height="100%" src="' + o
					+ '" frameborder="0" data-id="' + o
					+ '" seamless></iframe>';
			$(".J_mainContent").find("iframe.J_iframe").hide().parents(
					".J_mainContent").append(n);
			$(".J_menuTabs .page-tabs-content").append(p);
			g($(".J_menuTab.active"))
		}
		return false
	}
	//给J_menuItem绑定单击事件 
	$(".J_menuItem").on("click", c);
	function h() {
		var m = $(this).parents(".J_menuTab").data("id");
		var l = $(this).parents(".J_menuTab").width();
		if ($(this).parents(".J_menuTab").hasClass("active")) {
			if ($(this).parents(".J_menuTab").next(".J_menuTab").size()) {
				var k = $(this).parents(".J_menuTab").next(".J_menuTab:eq(0)")
						.data("id");
				$(this).parents(".J_menuTab").next(".J_menuTab:eq(0)")
						.addClass("active");
				$(".J_mainContent .J_iframe").each(function() {
					if ($(this).data("id") == k) {
						$(this).show().siblings(".J_iframe").hide();
						return false
					}
				});
				var n = parseInt($(".page-tabs-content").css("margin-left"));
				if (n < 0) {
					$(".page-tabs-content").animate({
						marginLeft : (n + l) + "px"
					}, "fast")
				}
				$(this).parents(".J_menuTab").remove();
				$(".J_mainContent .J_iframe").each(function() {
					if ($(this).data("id") == m) {
						$(this).remove();
						return false
					}
				})
			}
			if ($(this).parents(".J_menuTab").prev(".J_menuTab").size()) {
				var k = $(this).parents(".J_menuTab").prev(".J_menuTab:last")
						.data("id");
				$(this).parents(".J_menuTab").prev(".J_menuTab:last").addClass(
						"active");
				$(".J_mainContent .J_iframe").each(function() {
					if ($(this).data("id") == k) {
						$(this).show().siblings(".J_iframe").hide();
						return false
					}
				});
				$(this).parents(".J_menuTab").remove();
				$(".J_mainContent .J_iframe").each(function() {
					if ($(this).data("id") == m) {
						$(this).remove();
						return false
					}
				})
			}
		} else {
			$(this).parents(".J_menuTab").remove();
			$(".J_mainContent .J_iframe").each(function() {
				if ($(this).data("id") == m) {
					$(this).remove();
					return false
				}
			});
			g($(".J_menuTab.active"))
		}
		return false
	}
	$(".J_menuTabs").on("click", ".J_menuTab i", h);
	function i() {
		$(".page-tabs-content").children("[data-id]").not(":first").not(
				".active").each(function() {
			$('.J_iframe[data-id="' + $(this).data("id") + '"]').remove();
			$(this).remove()
		});
		$(".page-tabs-content").css("margin-left", "0")
	}
	$(".J_tabCloseOther").on("click", i);
	//定位当前tab
	function j() {
		//调用g函数 传入class=“J_menuTab.active”的对象
		g($(".J_menuTab.active"))
	}
	//定位当前激活的tab 调用j函数
	$(".J_tabShowActive").on("click", j);
	function e() {
		if (!$(this).hasClass("active")) {
			var k = $(this).data("id");
			$(".J_mainContent .J_iframe").each(function() {
				if ($(this).data("id") == k) {
					$(this).show().siblings(".J_iframe").hide();
					return false
				}
			});
			$(this).addClass("active").siblings(".J_menuTab").removeClass(
					"active");
			g(this)
		}
	}
	$(".J_menuTabs").on("click", ".J_menuTab", e);
	function d() {
		var l = $('.J_iframe[data-id="' + $(this).data("id") + '"]');
		var k = l.attr("src")
	}
	$(".J_menuTabs").on("dblclick", ".J_menuTab", d);
	$(".J_tabLeft").on("click", a);
	$(".J_tabRight").on("click", b);
	//关闭所有窗口 只留下首页
	$(".J_tabCloseAll")
			//当单击时
			.on(
					"click",
					function() {
						//遍历clsss=page-tabs-content的所有[data-id]的不是第一个的子元素
						//也就是把除了首页的全部都删掉
						$(".page-tabs-content").children("[data-id]").not(
								":first")
								.each(
										//遍历
										function() {
											//删除this的这个iframe
											$('.J_iframe[data-id="'+ $(this).data("id")+ '"]')
											.remove();
											//删除tab组件的对应这个iframe的选项卡
											$(this).remove()
											//从DOM中删除所有匹配的元素。
											//这个方法不会把匹配的元素从jQuery对象中删除，因而可以在将来再使用这些匹配的元素。但除了这个元素本身得以保留之外，其他的比如绑定的事件，附加的数据等都会被移除。

										});
						//找到首页
						$(".page-tabs-content").children("[data-id]:first")
								.each(
										//因为只有一个首页
										function() {
											//找到iframe窗体并且它的data-id=当前找到的第一个的也就是[data-id]:first这个首页的js对象的id设置为J_iframe的data-id
											$('.J_iframe[data-id="'+ $(this).data("id")+ '"]')
											.show();//显示出来
											$(this).addClass("active")//并对这个添加活动的class 表明当前活动的class是这个
										});
						//设置tab区的左外边框属性为0
						$(".page-tabs-content").css("margin-left", "0")
					})
					
	//新增功能 刷新当前tab
	$(".J_tabRefresh").on("click",function() {
		//首先获取当前active 状态的tab
		$(".page-tabs-content").children(".active")
		.each(
				//因为只有一个活动的tab页
				function() {
					
					//找到tab页面对应的iframe区域
					$('.J_iframe[data-id="'+ $(this).data("id")+ '"]')
					.attr('src', $('.J_iframe[data-id="'+ $(this).data("id")+ '"]').attr('data-id'));
					//思路找到当前的iframe然后 $('#iframe').attr('src', $('#iframe').attr('src'));
				});			
	})		
});
